---
- name: Upgrade Pre-Check Playbook for Cisco IOS and IOS-XE Devices
  hosts: all
  gather_facts: no
  vars:
    ansible_command_timeout: 10800
    scp_server: "{{ scp_server }}"
    scp_username: "{{ scp_username }}"
    scp_password: "{{ scp_password }}"
    new_ios_version: "{{ new_ios_version }}"
    new_ios_image: "{{ new_image_name }}"
    new_image_md5: "{{ new_image_md5 }}"

  tasks:
    - name: Get all elements hardware device
      cisco.ios.ios_facts:
        gather_subset: hardware
      register: pre_upgrade_facts

    - name: Display pre-upgrade facts
      debug:
        var: pre_upgrade_facts

    - name: Check current IOS version
      ansible.builtin.set_fact:    
        current_ios_version: "{{ pre_upgrade_facts.ansible_facts.ansible_net_version }}"

    - name: Display current IOS version
      debug:
        msg: 
          - "Current IOS Version: {{ current_ios_version }}"
          - "New IOS Version: {{ new_ios_version }}"

    - name: Stop Playbook if current version is same as new version
      ansible.builtin.fail:
        msg: "Current IOS version {{ current_ios_version }} is the same as the new version {{ new_ios_version }}. Upgrade not required."
      when: current_ios_version == new_ios_version

    - name: Check available memory
      ansible.builtin.set_fact:
        avl_mem: "{{ pre_upgrade_facts['ansible_facts']['ansible_net_filesystems_info']['bootflash:']['spacefree_kb'] }}"

    - name: Display available memory
      debug:
        msg: "Available memory: {{ (avl_mem | int / 1024 / 1024) | round(2) }} GB"

    - name: Stop playbook if memory is insufficient for new image
      block:
        - ansible.builtin.fail:
            msg: "Insufficient memory: Available memory is {{ avl_mem }} KB, which is less than required for new image."
          when: avl_mem | int < 2000000  # Assuming 2GB is required for the new image
      rescue:
        - name: Display insufficient memory warning
          debug:
            msg: "Warning: Available memory is less than required for the new image. Please free up space and try again."

    - name: Check current register status
      cisco.ios.ios_command:
        commands:
          - show version | include Configuration register
      register: reg_status

    - name: Display current register status
      debug:
        msg: "Current Configuration Register: {{ reg_status.stdout[0].split()[-1] }}"

    - name: Set fact for current register
      ansible.builtin.set_fact:
        current_register: "{{ reg_status.stdout[0].split()[-1] }}"

    - name: Change to boot from flash if register is not 0x2102
      cisco.ios.ios_config:
        lines:
          - config-register 0x2102
      when: current_register != '0x2102'

    - name: Check if new IOS image already exists on device
      cisco.ios.ios_command:
        commands:
          - "show flash: | include {{ new_ios_image }}"
      register: image_check
      failed_when: false

    - name: Handle IOS image copy and verification
      block:
        - name: Copy new IOS image to device using SCP
          cisco.ios.ios_command:
            commands:
              - command: 'copy scp://{{ scp_username }}:{{ scp_password }}@{{ scp_server }}/{{ new_ios_image }} flash:/{{ new_ios_image }}'
                prompt: 'Destination filename \[{{ new_ios_image }}\]?'
                answer: '{{ new_ios_image }}'
          register: image_copy_result
          when: image_check.stdout[0] == ""

        - name: Check if image copy was successful
          cisco.ios.ios_command:
            commands:
              - "show flash: | include {{ new_ios_image }}"
          register: image_check_after

        - name: Fail if image copy was unsuccessful
          ansible.builtin.fail:
            msg: "Image copy failed. The new IOS image {{ new_ios_image }} not found on device."
          when: image_check_after.stdout[0] == ""
      when: image_check.stdout[0] == ""

    - name: Display message if image already exists
      debug:
        msg: "The new IOS image {{ new_ios_image }} already exists on the device. Skipping copy step."
      when: image_check.stdout[0] != ""
    
    - name: Verify MD5 checksum of the new IOS image
      cisco.ios.ios_command:
        commands:
          - "verify /md5 flash:/{{ new_ios_image }} {{ new_image_md5 }}"
      register: md5_result

    - name: Display MD5 verification result
      debug:
        var: md5_result.stdout[0]

    